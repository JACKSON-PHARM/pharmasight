<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>PharmaSight - Pharmacy Management System</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Auth Layout Container (Unauthenticated routes only) -->
    <div id="authLayout" style="display: none;">
        <!-- Auth pages (login, password-set, etc.) will be rendered here -->
        <!-- Login Page -->
        <div id="login" class="page">
            <div class="login-container">
                <div class="login-card">
                    <h1><i class="fas fa-pills"></i> PharmaSight</h1>
                    <h2>Sign In</h2>
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="loginUsername">Username</label>
                            <input type="text" id="loginUsername" required placeholder="Enter your username">
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Password</label>
                            <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-sign-in-alt"></i> Sign In
                        </button>
                    </form>
                    <div id="loginError" class="error-message" style="display: none;"></div>
                    <div class="login-links">
                        <a href="#password-reset">Forgot Password?</a>
                    </div>
                </div>
            </div>
        </div>
        <div id="setup" class="page"></div>
        <div id="invite" class="page"></div>
        <div id="tenant-invite-setup" class="page"></div>
        <div id="password-set" class="page"></div>
        <div id="password-reset" class="page"></div>
    </div>
    
    <!-- App Layout Container (Authenticated routes only) -->
    <div class="app-container" id="appLayout" style="display: none;">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-pills"></i> <span class="sidebar-title">PharmaSight</span></h1>
                <button class="sidebar-toggle-btn" id="sidebarToggle" title="Collapse/Expand">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            <nav class="sidebar-nav" id="mainNav">
                <a href="#" class="nav-item active" data-page="landing" data-has-sub="false">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
                <a href="#" class="nav-item" data-page="dashboard" data-has-sub="false">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-page="sales" data-has-sub="true">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Sales</span>
                    <i class="fas fa-chevron-right nav-arrow"></i>
                </a>
                <a href="#" class="nav-item" data-page="purchases" data-has-sub="true">
                    <i class="fas fa-shopping-bag"></i>
                    <span>Purchases</span>
                    <i class="fas fa-chevron-right nav-arrow"></i>
                </a>
                <a href="#" class="nav-item" data-page="inventory" data-has-sub="true">
                    <i class="fas fa-warehouse"></i>
                    <span>Inventory</span>
                    <i class="fas fa-chevron-right nav-arrow"></i>
                </a>
                <a href="#" class="nav-item" data-page="expenses" data-has-sub="true">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Expenses</span>
                    <i class="fas fa-chevron-right nav-arrow"></i>
                </a>
                <a href="#" class="nav-item" data-page="reports" data-has-sub="true">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                    <i class="fas fa-chevron-right nav-arrow"></i>
                </a>
                <a href="#" class="nav-item" data-page="settings" data-has-sub="true">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                    <i class="fas fa-chevron-right nav-arrow"></i>
                </a>
            </nav>
            <!-- Sub Navigation (shown when main nav is collapsed) -->
            <nav class="sidebar-sub-nav" id="subNav" style="display: none;">
                <div class="sub-nav-header">
                    <button class="back-to-main-nav" id="backToMainNav" type="button">
                        <i class="fas fa-chevron-left"></i>
                        <span id="subNavTitle">Back</span>
                    </button>
                </div>
                <div class="sub-nav-items" id="subNavItems">
                    <!-- Sub-items will be dynamically inserted here -->
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <i class="fas fa-user-circle"></i>
                    <span id="username">Admin</span>
                </div>
                <button class="btn btn-link btn-sm" id="logoutBtn" onclick="if(window.globalLogout) window.globalLogout()" style="width: 100%; margin-top: 0.5rem; color: var(--text-secondary); text-decoration: none;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                <div class="sidebar-powered-by">
                    Powered by PharmaSight Solutions
                </div>
            </div>
        </aside>
        <div class="sidebar-backdrop" id="sidebarBackdrop" aria-hidden="true" title="Close menu"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <!-- Status Bar (phAMACore style) -->
                <div class="status-bar" id="statusBar">
                    <div class="user-menu-trigger" id="userMenuTrigger" title="Click for options">
                        <div class="status-item status-clickable">
                            <i class="fas fa-user"></i>
                            <span id="statusUser">Loading...</span>
                            <i class="fas fa-chevron-down user-menu-chevron"></i>
                        </div>
                        <div class="user-menu-dropdown" id="userMenuDropdown" aria-hidden="true">
                            <button type="button" class="user-menu-item" id="userMenuChangePassword">
                                <i class="fas fa-key"></i> Change password
                            </button>
                        </div>
                    </div>
                    <div class="status-divider">|</div>
                    <div class="status-item status-clickable" onclick="if(window.loadPage) window.loadPage('settings'); if(window.loadSettingsSubPage) setTimeout(() => window.loadSettingsSubPage('company'), 100);" title="Click to configure company">
                        <i class="fas fa-building"></i>
                        <span id="statusCompany">Not Set</span>
                    </div>
                    <div class="status-divider">|</div>
                    <div class="status-item status-clickable" onclick="if(window.loadPage) window.loadPage('settings'); if(window.loadSettingsSubPage) setTimeout(() => window.loadSettingsSubPage('branches'), 100);" title="Click to configure branch">
                        <i class="fas fa-code-branch"></i>
                        <span id="statusBranch">Not Set</span>
                    </div>
                </div>
                <!-- Global Item Search: same row as logout so it behaves like other top-bar controls -->
                <div id="globalItemSearchBar" class="global-item-search-bar top-bar-search">
                    <div class="global-item-search-wrap">
                        <input type="text" id="globalItemSearchInput" class="form-input" placeholder="Search item (name, SKU)‚Ä¶" autocomplete="off" aria-label="Search items" oninput="if(window.handleGlobalSearchInput)window.handleGlobalSearchInput(this);">
                        <div id="globalItemSearchDropdown" class="global-item-search-dropdown" style="display: none;" aria-hidden="true"></div>
                    </div>
                    <div id="globalSelectedItemRow" class="global-selected-item-row" style="display: none;">
                        <span id="globalSelectedItemName" class="global-selected-name"></span>
                        <span id="globalSelectedItemMeta" class="global-selected-meta"></span>
                        <div class="global-selected-actions">
                            <button type="button" class="btn btn-icon btn-primary" id="globalCreateInvoiceBtn" title="New sales invoice"><i class="fas fa-file-invoice-dollar"></i></button>
                            <button type="button" class="btn btn-icon btn-outline" id="globalCreateQuotationBtn" title="Quotation"><i class="fas fa-file-invoice"></i></button>
                            <button type="button" class="btn btn-icon btn-outline" id="globalCreateOrderBtn" title="Purchase order"><i class="fas fa-shopping-bag"></i></button>
                        </div>
                    </div>
                </div>
                <div class="top-bar-right">
                    <button class="btn btn-primary" id="newPurchaseBtn" style="display: none;">
                        <i class="fas fa-plus"></i> New Purchase
                    </button>
                    <button class="btn btn-secondary" id="logoutBtnTop" onclick="if(window.globalLogout) window.globalLogout()" title="Logout">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </header>

            <!-- Page Content (position: relative so overlay positions correctly) -->
            <div class="page-content" id="pageContent" style="position: relative;">
                <!-- Page load overlay: shown during navigation until target page is ready (smooth transitions) -->
                <div id="pageLoadOverlay" class="page-load-overlay" style="display: none; position: absolute; inset: 0; background: rgba(255,255,255,0.7); align-items: center; justify-content: center; z-index: 10; pointer-events: none;">
                    <div style="text-align: center;"><p style="margin-top: 0.5rem; font-size: 0.875rem;">Loading...</p></div>
                </div>
                <!-- Loading indicator -->
                <div id="appLoading" style="padding: 2rem; text-align: center; display: block;">
                    <p>Loading PharmaSight...</p>
                    <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">If this message doesn't disappear, check the browser console (F12) for errors.</p>
                </div>
                <!-- Dashboard will be loaded here -->
                <noscript>
                    <div style="padding: 2rem; text-align: center; color: var(--danger-color);">
                        <h2>JavaScript Required</h2>
                        <p>Please enable JavaScript to use PharmaSight.</p>
                    </div>
                </noscript>
                <!-- Landing: lightweight home, minimal queries -->
                <div id="landing" class="page">
                    <div class="landing-header">
                        <h2 id="landingWelcome">Welcome</h2>
                        <p class="landing-branch" id="landingBranch">Loading...</p>
                    </div>
                    <div class="landing-quick-stats" style="display: flex; flex-wrap: wrap; align-items: center; gap: 1rem;">
                        <div class="landing-stat">
                            <span class="landing-stat-value" id="landingPendingOrders">‚Äî</span>
                            <span class="landing-stat-label">Pending orders (today)</span>
                        </div>
                    </div>
                    <div class="landing-tiles">
                        <a href="#dashboard" class="landing-tile">
                            <span class="landing-tile-icon"><i class="fas fa-chart-line"></i></span>
                            <span class="landing-tile-label">Dashboard</span>
                            <span class="landing-tile-desc">View metrics &amp; KPIs</span>
                        </a>
                        <a href="#inventory" class="landing-tile">
                            <span class="landing-tile-icon"><i class="fas fa-warehouse"></i></span>
                            <span class="landing-tile-label">Inventory</span>
                            <span class="landing-tile-desc">Stock &amp; batches</span>
                        </a>
                        <a href="#sales" class="landing-tile">
                            <span class="landing-tile-icon"><i class="fas fa-shopping-cart"></i></span>
                            <span class="landing-tile-label">Orders / Sales</span>
                            <span class="landing-tile-desc">Invoices &amp; sales</span>
                        </a>
                        <a href="#purchases" class="landing-tile">
                            <span class="landing-tile-icon"><i class="fas fa-shopping-bag"></i></span>
                            <span class="landing-tile-label">Purchases &amp; Transfers</span>
                            <span class="landing-tile-desc">POs, order book, branch transfers</span>
                        </a>
                        <a href="#reports" class="landing-tile">
                            <span class="landing-tile-icon"><i class="fas fa-chart-bar"></i></span>
                            <span class="landing-tile-label">Reports</span>
                            <span class="landing-tile-desc">Analytics &amp; exports</span>
                        </a>
                    </div>
                </div>
                <div id="dashboard" class="page">
                    <h2>Dashboard</h2>
                    <div class="dashboard-toolbar">
                        <label for="dashboardPreset">Date range</label>
                        <select id="dashboardPreset" class="dashboard-preset">
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="this_week">This Week</option>
                            <option value="last_week">Last Week</option>
                            <option value="this_month">This Month</option>
                            <option value="last_month">Last Month</option>
                            <option value="this_year">This Year</option>
                            <option value="last_year">Last Year</option>
                            <option value="custom">Custom</option>
                        </select>
                        <div id="dashboardCustomRange" class="dashboard-custom-range" style="display: none;">
                            <input type="date" id="dashboardStartDate" />
                            <span>to</span>
                            <input type="date" id="dashboardEndDate" />
                        </div>
                        <button type="button" id="dashboardApplyBtn" class="btn btn-primary"><i class="fas fa-filter"></i> Apply</button>
                    </div>
                    <p class="dashboard-hint">Select a date range and click Apply to load metrics. No data is fetched until you apply.</p>
                    <div class="stats-grid" id="dashboardStatsGrid">
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-box"></i></div>
                            <div class="stat-info">
                                <h3 id="totalItems">‚Äî</h3>
                                <p>Items in database</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-warehouse"></i></div>
                            <div class="stat-info">
                                <h3 id="totalStock">‚Äî</h3>
                                <p>Unique items in stock</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-coins"></i></div>
                            <div class="stat-info">
                                <h3 id="totalStockValue">‚Äî</h3>
                                <p>Stock Value (KES)</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
                            <div class="stat-info">
                                <h3 id="todaySales">‚Äî</h3>
                                <p id="dashboardSalesLabel">Sales</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-file-invoice"></i></div>
                            <div class="stat-info">
                                <h3 id="ordersProcessed">‚Äî</h3>
                                <p>Orders processed</p>
                            </div>
                        </div>
                        <div class="stat-card stat-card-clickable" id="todayGrossProfitCard" title="Click to open financial reports" style="cursor: pointer;" onclick="if(typeof window.openFinancialReportsFromDashboard==='function') window.openFinancialReportsFromDashboard()">
                            <div class="stat-icon"><i class="fas fa-chart-pie"></i></div>
                            <div class="stat-info">
                                <h3 id="todayGrossProfit">‚Äî</h3>
                                <p id="todayGrossProfitMeta">Gross Profit</p>
                            </div>
                        </div>
                        <div class="stat-card stat-card-clickable" id="expiringSoonCard" title="Click to view details" style="cursor: pointer;" onclick="if(typeof showExpiringSoonModal==='function')showExpiringSoonModal()">
                            <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                            <div class="stat-info">
                                <h3 id="expiringItems">‚Äî</h3>
                                <p>Expiring Soon</p>
                            </div>
                        </div>
                        <div class="stat-card stat-card-clickable" id="orderBookPendingCard" title="Click to view pending order book items" style="cursor: pointer;" onclick="if(typeof showOrderBookPendingTodayModal==='function')showOrderBookPendingTodayModal()">
                            <div class="stat-icon"><i class="fas fa-clipboard-list"></i></div>
                            <div class="stat-info">
                                <h3 id="orderBookPendingToday">‚Äî</h3>
                                <p>Order Book Pending (Today)</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other pages will be loaded dynamically -->
                <div id="sales" class="page"></div>
                <div id="purchases" class="page"></div>
                <div id="inventory" class="page"></div>
                <div id="items" class="page"></div>
                <div id="stock-take" class="page"></div>
                <div id="expenses" class="page"></div>
                <div id="reports" class="page"></div>
                <div id="settings" class="page"></div>
                <div id="branch-select" class="page"></div>
            </div>
        </main>
    </div>
    <!-- End App Layout Container -->

    <!-- Modals -->
    <div id="modalOverlay" class="modal-overlay" style="display: none;">
        <div class="modal" id="modal">
            <!-- Modal content will be inserted here -->
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Cache busting: Add ?v=timestamp to force reload during development -->
    <script>
        // Early invite detection - handle /invite path before 404
        (function() {
            const pathname = window.location.pathname;
            const hash = window.location.hash || '';
            
            // If path is /invite, redirect to hash-based routing
            if (pathname === '/invite' || pathname === '/invite/') {
                console.log('[INVITE] Redirecting /invite path to hash routing');
                window.location.replace(window.location.origin + '/' + hash);
                return;
            }
            // Tenant invite setup: /setup?token=... -> set-password flow
            if (pathname === '/setup' || pathname === '/setup/') {
                const params = new URLSearchParams(window.location.search);
                const token = params.get('token');
                if (token) {
                    console.log('[SETUP] Redirecting /setup?token= to tenant-invite-setup');
                    window.location.replace(window.location.origin + '/?token=' + encodeURIComponent(token) + '#tenant-invite-setup');
                    return;
                }
            }
        })();
        
        // Diagnostic script - runs first to catch errors
        console.log('üîç PharmaSight: Starting initialization...');
        console.log('üîç Window location:', window.location.href);
        console.log('üîç Document ready state:', document.readyState);
        
        // Track script loading
        let scriptsLoaded = 0;
        const totalScripts = 11; // Count of script tags after this one
        
        // Monitor DOMContentLoaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('‚úÖ DOMContentLoaded event fired');
            });
        } else {
            console.log('‚úÖ DOM already loaded when diagnostic script ran');
        }
        
        // Ensure at least landing is visible if script fails
        window.addEventListener('error', function(e) {
            console.error('‚ùå JavaScript Error:', e.error);
            console.error('‚ùå Error at:', e.filename, 'line', e.lineno);
            console.error('‚ùå Error stack:', e.error?.stack);
            const landing = document.getElementById('landing');
            if (landing) {
                landing.classList.add('active');
                landing.style.display = 'block';
            }
        });
        
        // Log when document is fully loaded
        window.addEventListener('load', function() {
            console.log('‚úÖ Window load event fired - all resources loaded');
        });
    </script>
    <script src="js/config.js?v=7"></script>
    <script src="js/api.js?v=10"></script>
    <!-- Global Supabase Client (must load before auth modules) -->
    <script src="js/services/supabase_client.js?v=1"></script>
    <!-- Legacy auth (backward compatibility) -->
    <script src="js/auth.js?v=2"></script>
    <!-- New architecture services (depends on supabase_client) -->
    <script src="js/services/auth_bootstrap.js?v=2"></script>
    <script src="js/services/branch_context.js?v=1"></script>
    <script src="js/services/app_state.js?v=1"></script>
    <script src="js/services/optimistic_locking.js?v=1"></script>
    <script src="js/utils.js?v=7"></script>
    <!-- QZ Tray for thermal ESC/POS printing (optional; thermal prints fall back to browser if not loaded) -->
    <script src="https://cdn.jsdelivr.net/npm/qz-tray@2.2/qz-tray.js"></script>
    <script src="js/services/thermalPrinter.js?v=1"></script>
    <script src="js/services/printService.js?v=1"></script>
    <script src="js/utils/itemMapper.js?v=1"></script>
    <!-- Security Utilities -->
    <script src="js/utils/password_validation.js?v=1"></script>
    <script src="js/utils/session_timeout.js?v=1"></script>
    <script src="js/utils/login_security.js?v=1"></script>
    <!-- Permissions utilities -->
    <script src="js/utils/permissions.js?v=1"></script>
    <!-- Stock Take (before app.js so loadStockTake exists when router runs) -->
    <script src="js/pages/stock_take.js?v=9"></script>
    <!-- Bump version to force browser to load latest app.js after routing fixes -->
    <script src="js/app.js?v=18"></script>
    <script src="js/pages/login.js?v=1"></script>
    <script src="js/pages/password_reset.js?v=3"></script>
    <script src="js/pages/tenant_invite_setup.js?v=1"></script>
    <script>
        // Test: Verify password_reset.js loaded
        if (typeof window.loadPasswordReset === 'function') {
            console.log('‚úÖ TEST: window.loadPasswordReset is defined');
        } else {
            console.error('‚ùå TEST: window.loadPasswordReset is NOT defined!');
        }
    </script>
    <script src="js/pages/password_set.js?v=1"></script>
    <script src="js/pages/branch_select.js?v=3"></script>
    <script src="js/pages/setup.js?v=7"></script>
    <script src="js/pages/landing.js?v=1"></script>
    <script src="js/pages/dashboard.js?v=6"></script>
    <script src="js/pages/items.js?v=6"></script>
    <script src="js/pages/sales.js?v=5"></script>
    <script src="js/utils/searchCache.js"></script>
    <script src="js/components/TransactionItemsTable.js"></script>
    <script src="js/components/global_item_search.js"></script>
    <script src="js/components/batch-distribution.js"></script>
    <script src="js/pages/purchases.js?v=18"></script>
    <script src="js/pages/inventory.js?v=9"></script>
    <script src="js/pages/reports.js?v=1"></script>
    <script src="js/pages/settings.js?v=7"></script>
    <script src="js/pages/change_password.js?v=1"></script>
</body>
</html>

